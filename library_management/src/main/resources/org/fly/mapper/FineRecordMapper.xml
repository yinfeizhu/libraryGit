<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.fly.mapper.FineRecordMapper">

    <select id="selectPage" resultType="org.fly.entity.FineRecord">
        select fr.*,r.name as reader_name,r.phone as reader_phone,ba.barcode as book_barcode
        from fine_record fr
        left join user r on fr.reader_id=r.id
        left join borrow_record br on fr.borrow_id=br.id
        left join book_admin ba on br.book_admin_id=ba.id
            <where>
                    <if test="readerName != null and readerName != ''">
                        r.name like concat('%',#{readerName},'%')
                    </if>
                    <if test="readerPhone != null and readerPhone != ''">
                        and r.phone like concat('%',#{readerPhone},'%')
                    </if>
                    <if test="bookBarCode != null and bookBarCode !='' ">
                        and ba.barcode like concat('%',#{bookBarCode},'%')
                    </if>
            </where>
        order by fr.update_time desc
    </select>

    <insert id="add">
        insert into fine_record(reader_id,borrow_id,amount,reason,status,create_time,update_time)
        values(#{readerId},#{borrowId},#{amount},#{reason},#{status},#{createTime},#{updateTime})
    </insert>

    <update id="update">
        update fine_record
            <set>
                <if test="readerId != null and readerId!=''">
                    reader_id=#{readerId},
                </if>
                <if test="borrowId != null and borrowId!=''">
                    borrow_id=#{borrowId},
                </if>
                <if test="amount != null and amount!=''">
                    amount=#{amount},
                </if>
                <if test="reason != null">
                    reason=#{reason},
                </if>
                <if test="status != null and status!=''">
                    status=#{status},
                </if>
                <if test="createTime != null ">
                    create_time=#{createTime},
                </if>
                <if test="updateTime != null ">
                    update_time=#{updateTime},
                </if>
            </set>
        where id=#{id}
    </update>

    <delete id="deleteByIds">
        delete from fine_record where id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>

    <select id="getById" resultType="org.fly.entity.FineRecord">
        select fr.*,r.name as reader_name,r.phone as reader_phone,ba.barcode as book_barcode
        from fine_record fr
                 left join user r on fr.reader_id=r.id
                 left join borrow_record br on fr.borrow_id=br.id
                 left join book_admin ba on br.book_admin_id=ba.id
        where fr.id=#{id}
    </select>
    <!--    根据借阅记录id查询-->
    <select id="getByBorrowId" resultType="org.fly.entity.FineRecord">
        select fr.*,r.name as reader_name,r.phone as reader_phone,ba.barcode as book_barcode
        from fine_record fr
                 left join user r on fr.reader_id=r.id
                 left join borrow_record br on fr.borrow_id=br.id
                 left join book_admin ba on br.book_admin_id=ba.id
        where borrow_id=#{borrowId}
    </select>
    <!--    罚款原因统计-->
    <select id="selectFineReasonData" resultType="java.util.Map">
        select case
                   when reason = 1 then '逾期'
                   when reason = 2 then '损坏'
                   when reason = 3 then '丢失'
                   end as name,count(1) as num
                   from fine_record
        group by reason
    </select>
    <!--    支付状态统计-->
    <select id="selectPayStatusData" resultType="java.util.Map">
        select case
                   when status = 1 then '未支付'
                   when status = 2 then '已支付'
                   when status = 3 then '减免'
                   end as name,count(1) as num
                   from fine_record
        group by status
    </select>
</mapper>