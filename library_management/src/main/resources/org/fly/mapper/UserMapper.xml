<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.fly.mapper.UserMapper">
    <!--    封装所有属性-->
    <resultMap id="userMap" type="org.fly.entity.User">
        <id property="id" column="id"/>
        <result property="userName" column="userName"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="gender" column="gender"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="readerType" column="reader_type"/>
        <result property="borrowedNum" column="borrowed_num"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="status" column="status"/>
        <result property="role" column="role"/>
    </resultMap>
    <!--    分页查询-->
    <select id="selectPage" resultType="org.fly.entity.User">
        select * from user
        <where>
            <if test="name != null and name != ''">
                name like concat('%',#{name},'%')
            </if>
            <if test="readerType != null and readerType != ''">
                and reader_type = #{readerType}
            </if>
                and id!=1
        </where>

        order by update_time desc
    </select>

    <!--    添加读者-->
    <insert id="add">
        INSERT INTO user(userName,password,name,gender,phone,address,reader_type,borrowed_num,create_time,update_time,status,role)
        VALUES(#{userName},#{password},#{name},#{gender},#{phone},#{address},#{readerType},#{borrowedNum},#{createTime},#{updateTime},#{status},#{role})
    </insert>

    <!--更新读者信息-->
    <update id="update">
        update user
            <set>
                 <if test="userName != null and userName != ''">
                    userName = #{userName},
                </if>
                <if test="name != null and name != ''">
                    name = #{name},
                </if>
                <if test="gender != null and gender != ''">
                    gender = #{gender},
                </if>
                <if test="phone != null and phone != ''">
                    phone = #{phone},
                </if>
                <if test="address != null and address != ''">
                    address = #{address},
                </if>
                <if test="readerType != null and readerType != ''">
                    reader_type = #{readerType},
                </if>
                <if test="borrowedNum != null">
                    borrowed_num = #{borrowedNum},
                </if>
                <if test="password != null and password != '' ">
                    password=#{password},
                </if>
                <if test="updateTime != null">
                    update_time = #{updateTime},
                </if>
                <if test="status != null and status != ''">
                    status = #{status},
                </if>
                <if test="role != null and role != ''">
                    role = #{role},
                </if>
            </set>
        where id = #{id}
    </update>

    <!--批量删除-->
    <delete id="deleteByIds">
        delete from user where id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>

    <!--    根据id查询-->
    <select id="getById" resultType="org.fly.entity.User">
        select * from user where id = #{id}
    </select>

    <!--    用户登录-->
    <select id= "getByUserData" resultType="org.fly.entity.User">
        select * from user where userName = #{userName} and password = #{password}
    </select>

    <!--    统计男女人数，如果性别为空，则设为”未知”-->
    <select id="selectGenderData" resultType="java.util.Map">
        SELECT
        CASE
        WHEN gender = 1 THEN '男性'
        WHEN gender = 2 THEN '女性'
        ELSE '未知'
        END AS name,
        COUNT(*) AS num
        FROM user GROUP BY  gender
    </select>

    <!-- 统计读者的类型1学生/2教师/3职工/4其他 -->
    <select id="selectUserTypeData" resultType="java.util.Map">
        SELECT
            CASE
                WHEN reader_type = 1 THEN '学生'
                WHEN reader_type = 2 THEN '教师'
                WHEN reader_type = 3 THEN '职工'
                WHEN reader_type = 4 THEN '其他'
                ELSE '其他'
                END AS name,
            COUNT(*) AS num
        FROM user
        GROUP BY
            CASE
                WHEN reader_type = 1 THEN '学生'
                WHEN reader_type = 2 THEN '教师'
                WHEN reader_type = 3 THEN '职工'
                WHEN reader_type = 4 THEN '其他'
                ELSE '其他'
                END
    </select>
    <!--    获取最近一周的新增用户-->
    <select id="getNewUser" resultType="java.lang.Object">
        select
        count(*)
        from user
        where create_time >= date_sub(curdate(),interval 7 day)
        and status = 0
    </select>
</mapper>